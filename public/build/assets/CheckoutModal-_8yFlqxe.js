import{j as e,g as le,r as h,f as de}from"./currencyStore-Dk9RVyyc.js";import{u as ue}from"./SalesContext-CG9t8_rq.js";import{u as me}from"./currencyFormatter-Be2b0Ktm.js";import{useFirebase as he}from"./FirebaseContext-4dvVdyML.js";import{useAppConfig as xe}from"./AppConfigContext-XFUA3Mas.js";import{S as x}from"./sweetalert2.esm.all-q958Q1qq.js";import{D as pe,a as ge}from"./DialogContent-Cz4a0t2H.js";import{B as r}from"./Box-j1BTqM2v.js";import{c as W}from"./createSvgIcon-B7q9zImx.js";import{T as o}from"./Typography-DOI0NvTt.js";import{I as M}from"./IconButton-PbvyX_sG.js";import{C as L}from"./Close-B9rgBTOR.js";import{P as O}from"./Paper-Df0ljdBt.js";import{G as c}from"./Grid-6qcTmjc4.js";import{T as z}from"./TextField-DpXyhoD7.js";import{I as S}from"./InputAdornment-DZOHCUsF.js";import{P as fe}from"./Percent-BCjtx-gP.js";import{B as p}from"./Button-aMjmD1gp.js";import{C as V}from"./CreditCard-Dwl4hWaF.js";import{R as $}from"./Receipt-DnWIM4Bg.js";import{D as be}from"./Divider-D4ysiqwk.js";const q=W(e.jsx("path",{d:"M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4v-6h16zm0-10H4V6h16z"})),N=W(e.jsx("path",{d:"M4 10h3v7H4zm6.5 0h3v7h-3zM2 19h20v3H2zm15-9h3v7h-3zm-5-9L2 6v2h20V6z"})),G=W(e.jsx("path",{d:"M11 17h2v-1h1c.55 0 1-.45 1-1v-3c0-.55-.45-1-1-1h-3v-1h4V8h-2V7h-2v1h-1c-.55 0-1 .45-1 1v3c0 .55.45 1 1 1h3v1H9v2h2zm9-13H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2m0 14H4V6h16z"})),Q=W(e.jsx("path",{d:"M12.5 6.9c1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-.53.12-1.03.3-1.48.54l1.47 1.47c.41-.17.91-.27 1.51-.27M5.33 4.06 4.06 5.33 7.5 8.77c0 2.08 1.56 3.21 3.91 3.91l3.51 3.51c-.34.48-1.05.91-2.42.91-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c.96-.18 1.82-.55 2.45-1.12l2.22 2.22 1.27-1.27z"}));function ye({open:J,onClose:D}){const a=me(),w=le(t=>t.settings.currency_symbol),[T,C]=h.useState(""),[i,g]=h.useState([]),[k,E]=h.useState(!1),{cartState:R,cartTotal:v,totalQuantity:U,totalProfit:Y,charges:_,discount:l,finalTotal:je,calculateChargeAmountWithDiscount:K,setDiscount:P,calculateChargesWithDiscount:I,emptyCart:X}=ue(),{selectedCustomer:A,saleDate:Z,saleTime:ee}=h.useContext(de),{createSale:te,isInitialized:ne}=he(),{settings:se}=xe(),[H,B]=h.useState(0);h.useEffect(()=>{const t=I(l);B(t)},[_,v,l,I]);const u=v-l+H,m=i.reduce((t,s)=>t+s.amount,0),f=u-m,b=m>u?m-u:0,oe=t=>{const s=t.target.value,d=s!==""?parseFloat(s):0;P(d);const n=I(d);B(n)},re=()=>{if(l<0||l>100){x.fire({icon:"warning",title:"Invalid Percentage",text:"Discount must be between 0 and 100",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}const t=v*l/100;P(t);const s=I(t);B(s)},y=t=>{const s=parseFloat(T)||f;if(s<=0){x.fire({icon:"warning",title:"Invalid Amount",text:"Please enter a valid payment amount",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}if(t!=="Cash"&&s>f){x.fire({icon:"warning",title:"Amount Too Large",text:"Payment amount exceeds remaining balance",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}const d=i.findIndex(n=>n.method===t);if(d!==-1){const n=[...i];n[d].amount+=s,g(n),x.fire({icon:"success",title:"Payment Updated",text:`${t} payment updated to ${a(n[d].amount)}`,toast:!0,position:"top-end",showConfirmButton:!1,timer:2e3})}else g([...i,{method:t,amount:s}]);C("")},ae=t=>{const s=i.filter((d,n)=>n!==t);g(s)},ie=t=>{switch(t){case"Cash":return e.jsx(G,{sx:{color:"#16a34a"}});case"Card":return e.jsx(V,{sx:{color:"#2563eb"}});case"Cheque":return e.jsx($,{sx:{color:"#7c3aed"}});case"Bank":return e.jsx(N,{sx:{color:"#ea580c"}});case"Credit":return e.jsx(Q,{sx:{color:"#dc2626"}});default:return e.jsx(q,{})}},j=t=>{switch(t){case"Cash":return{bgcolor:"#16a34a","&:hover":{bgcolor:"#15803d"}};case"Card":return{bgcolor:"#2563eb","&:hover":{bgcolor:"#1d4ed8"}};case"Cheque":return{bgcolor:"#7c3aed","&:hover":{bgcolor:"#6d28d9"}};case"Bank":return{bgcolor:"#ea580c","&:hover":{bgcolor:"#c2410c"}};case"Credit":return{bgcolor:"#dc2626","&:hover":{bgcolor:"#b91c1c"}};default:return{bgcolor:"primary.main"}}},ce=async()=>{if(!k){E(!0);try{const t=`INV-${Date.now()}`,s={invoice_number:t,store_id:se?.store_id||1,contact_id:A?.id||null,sale_date:Z,sale_time:ee,discount:l||0,total_charge_amount:H||0,amount_received:m||0,net_total:u||0,change_amount:b||0,profit_amount:(Y||0)-(l||0),payment_method:i.length>0?i[0].method:"Cash",payment_status:"paid",status:"completed",note:"",items:R.map(n=>({id:n.id||null,batch_id:n.batch_id||null,batch_number:n.batch_number||null,quantity:n.quantity||0,price:n.price||0,cost:n.cost||0,discount:n.discount||0,flat_discount:n.flat_discount||0,is_stock_managed:n.is_stock_managed??1,is_free:n.is_free||0,free_quantity:n.free_quantity||0,category_name:n.category_name||null,product_type:n.product_type||"normal"})),charges:_.map(n=>({id:n.id||null,name:n.name||"",charge_type:n.charge_type||"tax",rate_value:n.rate_value||0,rate_type:n.rate_type||"percentage"})),transactions:i||[],created_by:"pos-offline",syncedFrom:"offline"},d=JSON.parse(JSON.stringify(s));ne?(console.log("ðŸ’¾ [CheckoutModal] Saving sale to Firebase:",t),await te(d),console.log("âœ… [CheckoutModal] createSale returned - showing success message")):console.warn("âš ï¸ Firebase not initialized, sale not saved"),console.log("ðŸŽ‰ [CheckoutModal] Displaying Swal success message"),x.fire({title:"Success!",text:`Sale ${t} completed successfully!`,icon:"success",showConfirmButton:!1,timer:2e3,timerProgressBar:!0}),X(),g([]),C(""),P(0),D()}catch(t){console.error("âŒ [CheckoutModal] Checkout error:",t),x.fire({icon:"error",title:"Checkout Failed",text:t.message||"An error occurred during checkout"})}finally{console.log("ðŸ”§ [CheckoutModal] Finally block - resetting isSubmitting"),E(!1)}}},F=()=>{g([]),C(""),P(0),D()};return e.jsxs(pe,{open:J,onClose:F,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{maxHeight:"95vh"}},children:[e.jsxs(r,{sx:{p:2.5,borderBottom:1,borderColor:"divider",display:"flex",alignItems:"center",justifyContent:"space-between",bgcolor:"primary.main",color:"white"},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(q,{sx:{fontSize:28}}),e.jsx(o,{variant:"h5",fontWeight:"bold",children:"Checkout & Payment"})]}),e.jsx(M,{onClick:F,size:"small",sx:{color:"white"},children:e.jsx(L,{})})]}),e.jsx(ge,{sx:{p:0,overflow:"auto",bgcolor:"grey.50"},children:e.jsxs(r,{sx:{p:3},children:[e.jsxs(O,{elevation:1,sx:{p:2.5,mb:3},children:[e.jsx(o,{variant:"h6",fontWeight:"bold",gutterBottom:!0,sx:{mb:2.5},children:"Bill Summary"}),e.jsxs(c,{container:!0,spacing:1.5,sx:{mb:2.5},children:[e.jsx(c,{size:{xs:12,sm:4},children:e.jsx(z,{fullWidth:!0,label:"Items",variant:"outlined",size:"medium",value:`${R.length} (Qty: ${U})`,InputLabelProps:{shrink:!0},InputProps:{readOnly:!0},sx:{"& .MuiOutlinedInput-root":{bgcolor:"grey.50",fontWeight:600}}})}),e.jsx(c,{size:{xs:12,sm:4},children:e.jsx(z,{fullWidth:!0,label:"Subtotal",variant:"outlined",size:"medium",value:a(v,!1),InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(S,{position:"start",children:w}),readOnly:!0},sx:{"& .MuiOutlinedInput-root":{bgcolor:"grey.50",fontWeight:600}}})}),e.jsx(c,{size:{xs:12,sm:4},children:e.jsx(z,{fullWidth:!0,type:"number",label:"Discount",variant:"outlined",size:"medium",value:l,onChange:oe,onFocus:t=>t.target.select(),InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(S,{position:"start",children:w}),endAdornment:e.jsx(S,{position:"end",children:e.jsx(M,{size:"small",color:"primary",onClick:re,title:"Convert to percentage",children:e.jsx(fe,{fontSize:"small"})})})}})})]}),_.length>0&&e.jsxs(r,{sx:{mb:2,p:1.5,bgcolor:"grey.50",borderRadius:1},children:[e.jsx(o,{variant:"caption",fontWeight:"600",color:"text.secondary",sx:{mb:1,display:"block"},children:"CHARGES & TAXES"}),_.map(t=>{const s=K(t);return e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",py:.75},children:[e.jsxs(o,{variant:"body2",color:"text.secondary",children:[t.name," ",t.rate_type==="percentage"?`(${t.rate_value}%)`:""]}),e.jsxs(o,{variant:"body2",fontWeight:"600",color:"success.main",children:["+",a(s)]})]},t.id)})]}),e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",p:2.5,mt:2,bgcolor:"primary.main",color:"white",borderRadius:1.5},children:[e.jsx(o,{variant:"h6",fontWeight:"bold",children:"Grand Total"}),e.jsx(o,{variant:"h4",fontWeight:"bold",children:a(u)})]})]}),e.jsxs(O,{elevation:1,sx:{p:2.5},children:[e.jsx(o,{variant:"h6",fontWeight:"bold",gutterBottom:!0,sx:{mb:2},children:"Payment Methods"}),e.jsx(z,{fullWidth:!0,type:"number",label:"Enter Amount",variant:"outlined",value:T,onChange:t=>C(t.target.value),placeholder:a(f,!1),inputProps:{step:"0.01"},InputLabelProps:{shrink:!0},InputProps:{startAdornment:e.jsx(S,{position:"start",children:w})},sx:{mb:2,"& input":{fontSize:"1.25rem",fontWeight:600}}}),e.jsxs(c,{container:!0,spacing:1.5,sx:{mb:2},children:[e.jsx(c,{size:{xs:6,sm:4},children:e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(G,{}),onClick:()=>y("Cash"),sx:j("Cash"),children:"CASH"})}),e.jsx(c,{size:{xs:6,sm:4},children:e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(V,{}),onClick:()=>y("Card"),sx:j("Card"),children:"CARD"})}),e.jsx(c,{size:{xs:6,sm:4},children:e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx($,{}),onClick:()=>y("Cheque"),sx:j("Cheque"),children:"CHEQUE"})}),e.jsx(c,{size:{xs:6,sm:4},children:e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(N,{}),onClick:()=>y("Bank"),sx:j("Bank"),children:"BANK"})}),A&&A.id!==1&&e.jsx(c,{size:{xs:6,sm:4},children:e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(Q,{}),onClick:()=>y("Credit"),sx:j("Credit"),children:"CREDIT"})})]}),i.length>0&&e.jsxs(r,{sx:{mt:3,pt:2,borderTop:1,borderColor:"divider"},children:[e.jsx(o,{variant:"subtitle2",fontWeight:"600",gutterBottom:!0,sx:{mb:1.5},children:"Payments Added"}),i.map((t,s)=>e.jsxs(r,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:1.5,mb:1,bgcolor:"grey.100",borderRadius:1},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[ie(t.method),e.jsx(o,{variant:"body1",fontWeight:"medium",children:t.method})]}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(o,{variant:"body1",fontWeight:"bold",children:a(t.amount)}),e.jsx(M,{size:"small",onClick:()=>ae(s),color:"error",children:e.jsx(L,{fontSize:"small"})})]})]},s))]}),e.jsxs(r,{sx:{mt:3,p:2,bgcolor:"grey.100",borderRadius:1},children:[e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(o,{variant:"body1",children:"Total"}),e.jsx(o,{variant:"body1",fontWeight:"600",children:a(u)})]}),e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(o,{variant:"body1",children:"Paid"}),e.jsx(o,{variant:"body1",fontWeight:"600",color:"success.main",children:a(m)})]}),e.jsx(be,{sx:{my:1}}),b>0?e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(o,{variant:"h6",fontWeight:"bold",children:"Change"}),e.jsx(o,{variant:"h5",fontWeight:"bold",color:"success.main",children:a(b)})]}):e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(o,{variant:"h6",fontWeight:"bold",children:"Remaining"}),e.jsx(o,{variant:"h5",fontWeight:"bold",color:f>0?"error.main":"success.main",children:a(f)})]})]}),m>=u&&i.length>0&&e.jsx(p,{fullWidth:!0,variant:"contained",size:"large",color:"success",onClick:ce,disabled:k,sx:{mt:3,py:2,fontSize:"1.125rem",fontWeight:"bold",boxShadow:3},children:k?"Processing...":b>0?`COMPLETE PAYMENT (Change: ${a(b)})`:"COMPLETE PAYMENT"})]})]})})]})}const Ve=Object.freeze(Object.defineProperty({__proto__:null,default:ye},Symbol.toStringTag,{value:"Module"}));export{ye as C,q as P,Ve as a};
